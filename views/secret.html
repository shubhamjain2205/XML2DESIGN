
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>X2D | Main</title>
  <link rel="icon" type="image/x-icon" href="image/fevicon.ico" /> <!-- Include Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" /> <!-- Include Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
  <!-- <script src="https://cdn.jsdelivr.net/npm/vkbeautify@0.100.3/dist/vkbeautify.js"></script> -->
  <style>
    .tree ul {
      list-style-type: none;
      padding-left: 20px;
    }

    .tree li::before {
      content: '- ';
      cursor: pointer;
    }

    .tree li.expanded::before {
      content: '+ ';
    }

    .tree .collapse {
      display: none;
    }
  </style>
  <script>
    async function populateXmlDropdown() {
      try {
        const response = await fetch('/getXmlIds');
        const xmlIds = await response.json();
        const dropdown = document.getElementById('xmlOptions');
  
        dropdown.innerHTML = '<option value="Select XML File">Select XML File</option>';
        xmlIds.forEach(xmlId => {
          dropdown.innerHTML += `<option value="${xmlId}">${xmlId}</option>`;
        });
      } catch (error) {
        console.error('Error fetching XML IDs:', error);
      }
    }


    //Extraction from dds xml
    async function extractAndDisplayInfo(xmlContent) {
  try {
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(xmlContent, "text/xml");

    // Extract and display data types (entire <types> section)
    const typesNode = xmlDoc.querySelector("types");
    if (typesNode) {
      const typesXml = new XMLSerializer().serializeToString(typesNode);
      document.getElementById("dataTypesTextbox").value = typesXml;
    }

    // Extract domain library
    const domainLibraryNode = xmlDoc.querySelector("domain_library");
    if (domainLibraryNode) {
      const domainLibrary = new XMLSerializer().serializeToString(domainLibraryNode);
      document.getElementById("domainLibraryTextbox").value = domainLibrary;
    }

    // Extract participant library
    const participantLibraryNode = xmlDoc.querySelector("domain_participant_library");
    if (participantLibraryNode) {
      const participantLibraryXml = new XMLSerializer().serializeToString(participantLibraryNode);
      document.getElementById("participantLibraryTextbox").value = participantLibraryXml;
    }

    // Extract quality of service
    const qosLibraryNode = xmlDoc.querySelector("qos_library");
if (qosLibraryNode) {
  const qosLibraryXml = new XMLSerializer().serializeToString(qosLibraryNode);
  document.getElementById("qosLibraryTextbox").value = qosLibraryXml;
}
  } catch (error) {
    console.error("Error extracting and displaying info:", error);
  }
}
function formatXml(xml) {
  const PADDING = ' '.repeat(2); // Number of spaces for each level of indentation
  const reg = /(>)(<)(\/*)/g;
  let pad = 0;

  return xml
    .replace(reg, '$1\r\n$2$3')
    .split('\r\n')
    .map((node) => {
      let indent = 0;
      if (node.match(/.+<\/\w[^>]*>$/)) {
        indent = 0;
      } else if (node.match(/^<\/\w/)) {
        if (pad !== 0) {
          pad -= 1;
        }
      } else if (node.match(/^<\w[^>]*[^\/]>.*$/)) {
        indent = 1;
      } else {
        indent = 0;
      }

      pad = Math.max(pad, 0);
      return `${PADDING.repeat(pad)}${node}`;
    })
    .join('\r\n');
}

    //load xml content
    async function loadXmlContent(xmlId) {
    try {
      const response = await fetch(`/getXmlData?id=${xmlId}`);
      const xmlContent = await response.text(); // Fetch the XML content as text
      const xmlContentDiv = document.getElementById('xmlContent');
      xmlContentDiv.innerHTML = `<pre>${escapeHtml(xmlContent)}</pre>`; // Display XML content

      // document.addEventListener('DOMContentLoaded', function () {
				function createTree(xmlNode, parentElement) {
					const ul = document.createElement('ul');
					parentElement.appendChild(ul);

					for (const node of xmlNode.children) {
						const li = document.createElement('li');
						const hasChildren = node.children.length > 0;
						if (hasChildren) {
							li.classList.add('expandable');
						} else {
							li.addEventListener('click', function (e) {
								e.stopPropagation();
							});
						}
						li.textContent = node.getAttribute('name') || node.nodeName;
						ul.appendChild(li);

						if (hasChildren) {
							createTree(node, li);
						}
					}
				}


				const parser = new DOMParser();
				const xmlDoc = parser.parseFromString(xmlContent, 'application/xml');
				const treeContainer = document.getElementById('treeContainer');
        console.log(treeContainer)

				const XMLDoc = xmlDoc.documentElement.outerHTML;
				xmlDoc.documentElement.innerHTML = XMLDoc;

				createTree(xmlDoc.documentElement, treeContainer.querySelector('ul'));

				const expandableNodes = document.querySelectorAll('.expandable');
				console.log(expandableNodes);

				expandableNodes.forEach((node) => {
					node.addEventListener('click', function (e) {
						node.classList.toggle('expanded');
						console.log(node);
						node.childNodes[1].classList.toggle('collapse');

						// Prevent triggering collapse/expand when clicking children
						e.stopPropagation();
					});
				});
			// });

      //

      extractAndDisplayInfo(xmlContent);
  
      // Add event listeners to each tag to toggle visibility
      const tags = xmlContentDiv.querySelectorAll('pre > *'); // Assuming tags are direct children of <pre>
      tags.forEach(tag => {
        tag.addEventListener('click', () => {
          toggleTagVisibility(tag);
        });
      });
    } catch (error) {
      console.error('Error loading XML content:', error);
    }
  }
  
  function toggleTagVisibility(tag) {
    const content = tag.querySelector(':scope > *'); // Assuming the tag's content is a direct child
    if (content) {
      content.classList.toggle('hidden'); // Add 'hidden' class to toggle visibility of content
    }
  }
  
  function escapeHtml(unsafe) {
    return unsafe
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }
  
    window.addEventListener('load', () => {
      populateXmlDropdown();
  
      const openXmlButton = document.getElementById('openXmlButton');
      const xmlOptions = document.getElementById('xmlOptions');
  
      openXmlButton.addEventListener('click', () => {
        const selectedXmlId = xmlOptions.value;
        if (selectedXmlId !== 'Select XML File') {
          loadXmlContent(selectedXmlId);
        }
      });
    });

  </script>
</head>

<body class="bg-gray-100">
  <!-- Navbar -->
  <nav class="bg-blue-500 py-4 px-8 flex items-center justify-between fixed-top w-full">
    <div class="flex items-center">
        <a href="home" class="flex items-center">
            <img src="image/logo-light.png" alt="Company Logo" class="h-8 w-8 mr-2" />
            <span class="text-white font-bold text-lg">XML2Design</span>
        </a>
        <div class="dropdown mx-4">
            <form action="/upload" method="post" enctype="multipart/form-data">
                <label class="btn btn-secondary">
                    Choose File
                    <input type="file" name="xmlFile" accept=".xml" class="hidden">
                </label>
                <button type="submit" class="btn btn-primary ml-2">Upload XML</button>
            </form>
        </div>
        <div class="dropdown d-flex align-items-center">
            <select id="xmlOptions" class="form-select">
                <option value="Select XML File">Select XML File</option>
                <!-- XML file options will be dynamically populated here -->
            </select>
            <button id="openXmlButton" class="btn btn-primary ml-4">Open</button>
        </div>
    </div>
    <div class="flex items-center">
        <a href="about" class="text-white mr-4">About</a>
        <a href="home" class="text-white mr-4">Home</a>
        <a href="contact" class="text-white mr-4">Contact</a>
        <div class="mr-4"> <img src="image/logger.png" alt="logger" class="h-8 w-8" /> </div>
        <a href="login">
            <button class="text-white bg-blue-700 rounded px-4 py-2 hover:bg-blue-800 transition">Logout</button>
        </a>
    </div>
</nav>
  <div class="container mx-auto mt-20">
    <!-- Add mt-20 to create space for the fixed navbar -->
    <div class="row">
      <!-- Aside Content (1 column wide) -->
      <aside class="bg-gray-300 py-8 px-4 col-md-3 sticky-aside">
        <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
          <li class="nav-item" role="presentation"> <button class="nav-link active" id="pills-home-tab" data-bs-toggle="pill" data-bs-target="#types" type="button" role="tab" aria-controls="pills-home" aria-selected="true" onclick="tab(1)"> Types </button> </li>
        </ul>
        <!-- Tree-like Content Highlight (Replace with your content) -->
        <div id="treeContainer" class="tree">
          <ul>
            <li class="expandable">XML</li>
          </ul>
        </div>
      </aside> <!-- Home Page Content (5 columns wide on medium and larger screens) -->
      <main class="flex-1 p-8 col-md-5 main-content">
        <!-- Tab Buttons -->
        <!--types-->
        <div id="structured" hidden>
          <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation"> <button class="nav-link active" id="pills-home-tab" data-bs-toggle="pill" data-bs-target="#pills-home" type="button" role="tab" aria-controls="pills-home" aria-selected="true"> Structured </button> </li>
            <li class="nav-item" role="presentation"> <button class="nav-link" id="pills-profile-tab" data-bs-toggle="pill" data-bs-target="#pills-profile" type="button" role="tab" aria-controls="pills-profile" aria-selected="false"> XML </button> </li>
            <li class="nav-item" role="presentation"> <button class="nav-link" id="pills-contact-tab" data-bs-toggle="pill" data-bs-target="#pills-contact" type="button" role="tab" aria-controls="pills-contact" aria-selected="false"> IDL </button> </li>
          </ul>
        </div>

        <!--domain-->
        <!--participant-->
        <div id="participant">
          <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation"> <button class="nav-link active" id="pills-home-tab" data-bs-toggle="pill" data-bs-target="#ddps" type="button" role="tab" aria-controls="pills-home" aria-selected="true"> Structured </button> </li>
            <li class="nav-item" role="presentation"> <button class="nav-link" id="pills-profile-tab" data-bs-toggle="pill" data-bs-target="#pxxml" type="button" role="tab" aria-controls="pills-profile" aria-selected="false"> XML </button> </li>
            <li class="nav-item" role="presentation"> <button class="nav-link" id="pills-contact-tab" data-bs-toggle="pill" data-bs-target="#dxxml" type="button" role="tab" aria-controls="pills-contact" aria-selected="false"> Design </button> </li>
          </ul>
          <div class="tab-content" id="pills-tabContent">
            <div class="tab-pane fade show active" id="ddps" role="tabpanel" aria-labelledby="pills-home-tab" tabindex="0">
              <ul class="nav nav-pills mb-3 mt-3" id="pills-tab" role="tablist">
                <li class="nav-item" role="presentation"> <button class="nav-link active" id="pills-home-tab" data-bs-toggle="pill" data-bs-target="#pubs" type="button" role="tab" aria-controls="pills-home" aria-selected="true"> Publications </button> </li>
                <li class="nav-item" role="presentation"> <button class="nav-link" id="pills-profile-tab" data-bs-toggle="pill" data-bs-target="#subs" type="button" role="tab" aria-controls="pills-profile" aria-selected="false"> Subscriptions </button> </li>
              </ul>
              <div class="tab-content" id="pills-tabContent">
                <div class="tab-pane fade show active" id="pubs" role="tabpanel" aria-labelledby="pills-home-tab" tabindex="0">
                  <div class="bg-blue-100 w-full p-2.5" style="display: flex; justify-content: space-between"> <label>Data types</label>
                    <div> <button type="button" class="btn btn-secondary"> <i class="fa fa-pencil"></i> Edit </button> <button type="button" class="btn btn-secondary"> <i class="fa fa-plus-circle"></i> Add </button> <button type="button" class="btn btn-secondary"> <i class="fa fa-trash"></i> Delete </button> </div>
                  </div>
                  <div class="bg-blue-100 w-full p-2.5" style="display: flex; justify-content: space-between"> <label>Data types struct</label>
                    <div> <label>Qos</label> </div>
                  </div> <textarea id="dataTypesTextbox" class="form-control" style="height: 30vh" readonly></textarea>

                  <div class="bg-blue-100 w-full p-2.5" style="display: flex; justify-content: space-between"> <label>Domain library</label>
                    <div> <button type="button" class="btn btn-secondary"> <i class="fa fa-pencil"></i> Edit </button> <button type="button" class="btn btn-secondary"> <i class="fa fa-plus-circle"></i> Add </button> <button type="button" class="btn btn-secondary"> <i class="fa fa-trash"></i> Delete </button> </div>
                  </div>
                  <div class="bg-blue-100 w-full p-2.5" style="display: flex; justify-content: space-between"> <label>Domain library name</label> <label>Topic</label> <label>QOS</label> </div> <textarea id="domainLibraryTextbox" class="form-control" style="height: 20vh"  readonly></textarea>
                </div>
                <div class="tab-pane fade" id="subs" role="tabpanel" aria-labelledby="pills-profile-tab" tabindex="0">
                  <div class="bg-blue-100 w-full p-2.5" style="display: flex; justify-content: space-between"> <label>Participant library</label>
                    <div> <button type="button" class="btn btn-secondary"> <i class="fa fa-pencil"></i> Edit </button> <button type="button" class="btn btn-secondary"> <i class="fa fa-plus-circle"></i> Add </button> <button type="button" class="btn btn-secondary"> <i class="fa fa-trash"></i> Delete </button> </div>
                  </div>
                  <div class="bg-blue-100 w-full p-2.5" style="display: flex; justify-content: space-between"> <label>Participant library name</label>
                    <div> <label>Qos</label> </div>
                  </div> <textarea id="participantLibraryTextbox" class="form-control" style="height: 30vh" readonly>             
                </textarea>
                  <div class="bg-blue-100 w-full p-2.5" style="display: flex; justify-content: space-between"> <label>Quality of Service</label>
                    <div> <button type="button" class="btn btn-secondary"> <i class="fa fa-pencil"></i> Edit </button> <button type="button" class="btn btn-secondary"> <i class="fa fa-plus-circle"></i> Add </button> <button type="button" class="btn btn-secondary"> <i class="fa fa-trash"></i> Delete </button> </div>
                  </div>
                  <div class="bg-blue-100 w-full p-2.5" style="display: flex; justify-content: space-between"> <label>Quality of Service name</label> <label>Topic</label> <label>QOS</label> </div> <textarea id="qosLibraryTextbox" class="form-control" style="height: 20vh" aria-label="With textarea" readonly>   
                </textarea>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="pxxml" role="tabpanel" aria-labelledby="pills-profile-tab" tabindex="0">
          <div class="bg-blue-100 w-full p-2.5"> <label class="mr-5">XML: FILE</label>
            <div class="btn-group dropdown-center" style="width: 78%"><select id="xmlOptions" class="form-select"> <option value="Select XML File" type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false"> XML File </option></select>
            </div> <button type="button" class="btn btn-secondary"> <i class="fa fa-pencil"></i> Edit XML </button> &nbsp; &nbsp; <i class="fa fa-question-circle"></i> &nbsp;
          </div>
          <div class="input-group" id="xmlContent"> <textarea class="form-control" style="height: 80vh" aria-label="With textarea" readonly>
          </div>
        </div>
        <div class="tab-pane fade" id="dxxml" role="tabpanel" aria-labelledby="pills-contact-tab" tabindex="0">
          hello
        </div>
    </div>
  </div>
  </main>
  </div>
  </div>
</body>

</html>